<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LogCash App + Admin</title>
<style>
  body, html {
    margin: 0; padding: 0; height: 100%;
    background: linear-gradient(270deg, #0d001f, #330066, #660099, #330066);
    background-size: 800% 800%;
    animation: bgAnim 20s ease infinite;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #eee;
    user-select: none;
  }
  @keyframes bgAnim {
    0%{background-position:0% 50%}
    50%{background-position:100% 50%}
    100%{background-position:0% 50%}
  }
  #container {
    max-width: 420px;
    margin: 2rem auto;
    background: #110022cc;
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 0 30px #bb33ffaa;
  }
  h1, h2, h3 {
    text-align: center;
    margin-bottom: 1rem;
    text-shadow: 0 0 8px #bb33ffcc;
  }
  input[type="email"], input[type="password"], input[type="text"], select {
    width: 100%;
    padding: 10px 12px;
    margin: 10px 0 15px 0;
    border-radius: 12px;
    border: 3px solid transparent;
    background: #220044dd;
    color: #eee;
    font-size: 1rem;
    outline: none;
    box-shadow: 4px 4px 10px #330066cc, inset 0 0 15px #660099cc;
    transition: border 0.3s ease;
  }
  input[type="email"]:focus, input[type="password"]:focus, input[type="text"]:focus, select:focus {
    border: 3px solid;
    border-image-slice: 1;
    border-image-source: linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet);
    box-shadow: 0 0 15px #bb33ffcc, inset 0 0 15px #aa33ffaa;
  }
  button {
    width: 48%;
    margin: 5px 1% 20px 1%;
    padding: 12px 0;
    border-radius: 14px;
    border: none;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    background: linear-gradient(45deg, #4400bb, #bb33ff);
    color: #eee;
    box-shadow: 0 0 15px #bb33ffaa;
    transition: background 0.3s ease;
  }
  button:hover {
    background: linear-gradient(45deg, #bb33ff, #4400bb);
  }
  #notification {
    position: fixed;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    background: #330066cc;
    padding: 15px 30px;
    border-radius: 16px;
    box-shadow: 0 0 20px #bb33ffcc;
    font-weight: 700;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s ease;
    z-index: 9999;
  }
  #notification.show {
    opacity: 1;
    pointer-events: auto;
  }
  #dashboard, #adminPanel {
    display: none;
    margin-top: 1rem;
  }
  #logcash {
    font-size: 1.4rem;
    font-weight: 900;
    margin-bottom: 1.5rem;
    color: #bb33ff;
    text-shadow: 0 0 10px #bb33ffbb;
    text-align:center;
  }
  #shopItems button {
    margin: 0 5px 10px 0;
    width: auto;
    padding: 8px 14px;
  }
  #leaderboard table {
    width: 100%;
    border-collapse: collapse;
    color: #eee;
  }
  #leaderboard th, #leaderboard td {
    border: 1px solid #bb33ff88;
    padding: 8px;
    text-align: center;
  }
  #leaderboard th {
    background: #330066cc;
  }
  #leaderboard td {
    background: #220044cc;
  }
  #banList {
    margin-bottom: 1rem;
  }
</style>
</head>
<body>
<div id="notification"></div>

<div id="container">
  <h1>LogCash App</h1>

  <div id="authUI">
    <input type="email" id="email" placeholder="Email (unique username)" />
    <input type="password" id="password" placeholder="Password" />
    <div>
      <button id="signupBtn">Sign Up</button>
      <button id="loginBtn">Log In</button>
    </div>
  </div>

  <div id="dashboard">
    <h2>Welcome, <span id="usernameDisplay"></span>!</h2>
    <div id="logcash">LogCash: 0</div>

    <div id="shop">
      <h3>Shop</h3>
      <div id="shopItems"></div>
    </div>

    <div id="leaderboard">
      <h3>Leaderboard</h3>
      <table>
        <thead>
          <tr>
            <th>Username</th>
            <th>LogCash</th>
            <th>Titles</th>
            <th>Styles</th>
          </tr>
        </thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
    </div>
  </div>

  <div id="adminPanel">
    <h2>Admin Panel</h2>

    <div id="banList">
      <h3>Banned Users</h3>
      <ul id="bannedUsersList"></ul>
    </div>

    <input type="text" id="banInput" placeholder="Email or Username to ban" />
    <button id="banBtn">Ban User</button>

    <h3>Add LogCash to User</h3>
    <input type="text" id="addLogcashUser" placeholder="User Email or Username" />
    <input type="number" id="addLogcashAmount" placeholder="Amount" min="1" />
    <button id="addLogcashBtn">Add LogCash</button>

    <button id="refreshAdminData" style="margin-top: 15px;">Refresh Data</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    onAuthStateChanged,
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
  import {
    getDatabase,
    ref,
    set,
    get,
    update,
    child,
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBjA2O3QDuKsAGLzq008VEDug69WDroulI",
    authDomain: "supercoollogin999.firebaseapp.com",
    databaseURL: "https://supercoollogin999-default-rtdb.firebaseio.com",
    projectId: "supercoollogin999",
    storageBucket: "supercoollogin999.firebasestorage.app",
    messagingSenderId: "472488806884",
    appId: "1:472488806884:web:885f97531677a384c51ff1",
    measurementId: "G-FSD3TZLK82",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // UI refs
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const signupBtn = document.getElementById("signupBtn");
  const loginBtn = document.getElementById("loginBtn");
  const notification = document.getElementById("notification");
  const authUI = document.getElementById("authUI");
  const dashboard = document.getElementById("dashboard");
  const usernameDisplay = document.getElementById("usernameDisplay");
  const logcashDisplay = document.getElementById("logcash");
  const shopItems = document.getElementById("shopItems");
  const leaderboardBody = document.getElementById("leaderboardBody");
  const adminPanel = document.getElementById("adminPanel");
  const bannedUsersList = document.getElementById("bannedUsersList");
  const banInput = document.getElementById("banInput");
  const banBtn = document.getElementById("banBtn");
  const addLogcashUser = document.getElementById("addLogcashUser");
  const addLogcashAmount = document.getElementById("addLogcashAmount");
  const addLogcashBtn = document.getElementById("addLogcashBtn");
  const refreshAdminData = document.getElementById("refreshAdminData");

  let currentUser = null;
  let isAdmin = false;

  // Shop items (styles and titles)
  const shopCatalog = [
    { id: "style_purple", name: "Purple Glow", price: 50, type: "style" },
    { id: "style_gold", name: "Golden Shine", price: 100, type: "style" },
    { id: "title_novice", name: "Novice", price: 30, type: "title" },
    { id: "title_master", name: "Master", price: 200, type: "title" },
  ];

  // Show notification helper
  function showNotification(msg, time = 2500) {
    notification.textContent = msg;
    notification.classList.add("show");
    setTimeout(() => notification.classList.remove("show"), time);
  }

  // Validate user email or username exists & return their data
  async function getUserDataByEmailOrUsername(id) {
    id = id.toLowerCase();
    // Check email key first
    const emailKey = id.replace(/\./g, ",");
    let snap = await get(ref(db, `users/${emailKey}`));
    if (snap.exists()) return { key: emailKey, data: snap.val() };

    // Else, search all users for username match (slow but rare)
    let allUsersSnap = await get(ref(db, "users"));
    if (!allUsersSnap.exists()) return null;
    let users = allUsersSnap.val();
    for (const [key, user] of Object.entries(users)) {
      if (user.username && user.username.toLowerCase() === id) {
        return { key, data: user };
      }
    }
    return null;
  }

  // Check if user is banned (by email or username)
  async function isBanned(email, username) {
    const bannedSnap = await get(ref(db, "bannedUsers"));
    if (!bannedSnap.exists()) return false;
    const banned = bannedSnap.val();
    email = email.toLowerCase();
    username = username.toLowerCase();
    return (banned.emails && banned.emails[email]) || (banned.usernames && banned.usernames[username]);
  }

  // Save user data safely, merging to existing data
  async function saveUserData(emailKey, data) {
    await update(ref(db, `users/${emailKey}`), data);
  }

  // Initialize user data on signup/login
  async function initUserData(email) {
    const emailKey = email.replace(/\./g, ",");
    let snap = await get(ref(db, `users/${emailKey}`));
    if (!snap.exists()) {
      await set(ref(db, `users/${emailKey}`), {
        username: email.split("@")[0],
        logcash: 0,
        boughtStyles: {},
        boughtTitles: {},
      });
      return {
        username: email.split("@")[0],
        logcash: 0,
        boughtStyles: {},
        boughtTitles: {},
      };
    }
    return snap.val();
  }

  // Update dashboard UI for user
  function updateDashboardUI(userData) {
    usernameDisplay.textContent = userData.username || currentUser.email.split("@")[0];
    logcashDisplay.textContent = `LogCash: ${userData.logcash || 0}`;
  }

  // Render shop buttons
  function renderShop(userData) {
    shopItems.innerHTML = "";
    shopCatalog.forEach((item) => {
      const owned = item.type === "style"
        ? userData.boughtStyles && userData.boughtStyles[item.id]
        : userData.boughtTitles && userData.boughtTitles[item.id];
      const btn = document.createElement("button");
      btn.textContent = owned ? `${item.name} âœ“` : `${item.name} - ${item.price} LC`;
      btn.disabled = owned || (userData.logcash < item.price);
      btn.onclick = async () => {
        if (userData.logcash < item.price) {
          showNotification("Not enough LogCash!");
          return;
        }
        // Deduct cost and save purchase
        userData.logcash -= item.price;
        if (item.type === "style") {
          userData.boughtStyles = userData.boughtStyles || {};
          userData.boughtStyles[item.id] = true;
        } else {
          userData.boughtTitles = userData.boughtTitles || {};
          userData.boughtTitles[item.id] = true;
        }
        await saveUserData(currentUser.email.replace(/\./g, ","), {
          logcash: userData.logcash,
          boughtStyles: userData.boughtStyles,
          boughtTitles: userData.boughtTitles,
        });
        updateDashboardUI(userData);
        renderShop(userData);
        renderLeaderboard(); // update leaderboard too
        showNotification(`Bought ${item.name}!`);
      };
      shopItems.appendChild(btn);
    });
  }

  // Render leaderboard
  async function renderLeaderboard() {
    const snap = await get(ref(db, "users"));
    if (!snap.exists()) {
      leaderboardBody.innerHTML = "<tr><td colspan='4'>No users found</td></tr>";
      return;
    }
    const users = Object.values(snap.val());
    // Sort descending by LogCash
    users.sort((a, b) => (b.logcash || 0) - (a.logcash || 0));
    leaderboardBody.innerHTML = "";
    users.forEach(u => {
      const tr = document.createElement("tr");
      const titles = u.boughtTitles ? Object.keys(u.boughtTitles).join(", ") : "";
      const styles = u.boughtStyles ? Object.keys(u.boughtStyles).join(", ") : "";
      tr.innerHTML = `
        <td>${u.username || "Unknown"}</td>
        <td>${u.logcash || 0}</td>
        <td>${titles}</td>
        <td>${styles}</td>
      `;
      leaderboardBody.appendChild(tr);
    });
  }

  // Load banned users list in admin panel
  async function loadBannedUsers() {
    const snap = await get(ref(db, "bannedUsers"));
    bannedUsersList.innerHTML = "";
    if (!snap.exists()) {
      bannedUsersList.textContent = "No banned users.";
      return;
    }
    const banned = snap.val();
    const emails = banned.emails ? Object.keys(banned.emails) : [];
    const usernames = banned.usernames ? Object.keys(banned.usernames) : [];
    emails.forEach(e => {
      const li = document.createElement("li");
      li.textContent = `Email: ${e.replace(/,/g,".")}`;
      bannedUsersList.appendChild(li);
    });
    usernames.forEach(u => {
      const li = document.createElement("li");
      li.textContent = `Username: ${u}`;
      bannedUsersList.appendChild(li);
    });
  }

// After user logs in or signs up and you get their email
function checkAdmin(user) {
  if (!user) return false;
  return user.email.toLowerCase() === "ppggyar@gmail.com";
}

// Call this after auth state changed:
onAuthStateChanged(auth, async (user) => {
  if (user) {
    // Show dashboard UI
    authUI.style.display = "none";
    dashboard.style.display = "block";

    // Show admin panel only if user is admin
    if (checkAdmin(user)) {
      adminPanel.style.display = "block";
    } else {
      adminPanel.style.display = "none";
    }

    // Load user data, update UI, etc.
    // ...
  } else {
    authUI.style.display = "block";
    dashboard.style.display = "none";
    adminPanel.style.display = "none";
  }
});

// Ban a user by email or username
  async function banUser(id) {
    id = id.toLowerCase();
    const bannedRef = ref(db, "bannedUsers");
    const bannedSnap = await get(bannedRef);
    let banned = bannedSnap.exists() ? bannedSnap.val() : { emails: {}, usernames: {} };

    // Check if id looks like email (contains @)
    if (id.includes("@")) {
      // Convert email dots to commas for key
      const emailKey = id.replace(/\./g, ",");
      banned.emails = banned.emails || {};
      if (banned.emails[emailKey]) {
        showNotification("User already banned.");
        return;
      }
      banned.emails[emailKey] = true;
    } else {
      // Treat as username
      banned.usernames = banned.usernames || {};
      if (banned.usernames[id]) {
        showNotification("User already banned.");
        return;
      }
      banned.usernames[id] = true;
    }

    await set(bannedRef, banned);
    showNotification("User banned successfully.");
    loadBannedUsers();
  }
  
  // Add LogCash to a user by email or username
  async function addLogCashToUser(id, amount) {
    if (amount <= 0) {
      showNotification("Amount must be positive.");
      return;
    }
    const userEntry = await getUserDataByEmailOrUsername(id);
    if (!userEntry) {
      showNotification("User not found.");
      return;
    }

    // Update logcash
    const newLogcash = (userEntry.data.logcash || 0) + amount;
    await update(ref(db, `users/${userEntry.key}`), { logcash: newLogcash });
    showNotification(`Added ${amount} LogCash to ${userEntry.data.username || id}.`);

    if (currentUser && currentUser.email.replace(/\./g, ",") === userEntry.key) {
      // If it's the current user, update UI
      updateDashboardUI({ ...userEntry.data, logcash: newLogcash });
      renderShop({ ...userEntry.data, logcash: newLogcash });
    }

    renderLeaderboard();
  }
  
  
  banBtn.onclick = () => {
    const id = banInput.value.trim();
    if (!id) {
      showNotification("Enter an email or username to ban.");
      return;
    }
    banUser(id);
    banInput.value = "";
  };

  addLogcashBtn.onclick = () => {
    const id = addLogcashUser.value.trim();
    const amount = parseInt(addLogcashAmount.value, 10);
    if (!id || isNaN(amount)) {
      showNotification("Enter user and valid amount.");
      return;
    }
    addLogCashToUser(id, amount);
    addLogcashUser.value = "";
    addLogcashAmount.value = "";
  };

  refreshAdminData.onclick = () => {
    loadBannedUsers();
    renderLeaderboard();
  };